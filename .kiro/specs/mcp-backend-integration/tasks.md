# 实现计划

- [x] 1. 建立项目基础结构和核心接口






  - 创建两个 Spring Boot 项目：MCP Host 服务和 MCP Client 服务
  - 配置 gRPC 依赖和基础项目结构
  - 定义核心接口和基础异常类
  - _需求: 6.1, 1.1_

- [x] 2. 定义 gRPC 协议和数据模型






  - [x] 2.1 创建 gRPC 协议定义文件


    - 编写 mcp-service.proto 文件定义 MCP 服务接口
    - 定义 MCPToolRequest、MCPToolResponse 等消息类型
    - 生成 Java gRPC 客户端和服务端代码
    - _需求: 6.1, 6.2_

  - [x] 2.2 实现核心数据模型




    - 创建 MCPInstruction、MCPToolResult、ConversationRequest 等数据类
    - 添加 JSON 序列化注解和验证规则
    - 编写数据模型的单元测试
    - _需求: 4.1, 4.2, 5.1_

- [x] 3. 实现 LLM 客户端集成




  - [x] 3.1 创建 LLM 客户端接口和实现


    - 定义 LLMClient 接口支持多种大模型提供商
    - 实现 OpenAIClient、ClaudeClient 等具体实现
    - 添加 API 密钥配置和请求限流逻辑
    - _需求: 3.1, 3.2_

  - [x] 3.2 实现 LLM 响应处理


    - 创建 LLMResponse 数据模型
    - 实现流式响应处理和错误处理
    - 编写 LLM 客户端的单元测试
    - _需求: 3.3, 3.4_

- [x] 4. 实现 JSON 指令解析器




  - [x] 4.1 创建指令解析核心逻辑


    - 实现 JSONInstructionParser 类
    - 添加正则表达式匹配 JSON 代码块的逻辑
    - 实现 MCP 指令格式验证和解析
    - _需求: 4.1, 4.2_

  - [x] 4.2 实现指令验证和错误处理


    - 添加指令格式验证逻辑
    - 实现解析失败的错误处理和日志记录
    - 编写指令解析器的单元测试
    - _需求: 4.3, 4.4_

- [x] 5. 实现 MCP Host 服务核心组件




  - [x] 5.1 创建对话服务


    - 实现 ConversationService 类协调整个对话流程
    - 集成 LLM 客户端和指令解析器
    - 实现会话上下文管理和消息历史记录
    - _需求: 5.1, 5.2_

  - [x] 5.2 实现 MCP Host 服务


    - 创建 MCPHostService 处理 MCP 指令执行
    - 实现 gRPC 客户端调用 MCP Client 服务
    - 添加响应内容替换和格式化逻辑
    - _需求: 5.3, 6.1, 6.2_

- [x] 6. 实现系统提示构建器




  - [x] 6.1 创建提示构建核心逻辑


    - 实现 MCPSystemPromptBuilder 类
    - 通过 gRPC 获取可用工具列表
    - 构建包含工具信息的系统提示
    - _需求: 3.2, 6.1_

  - [x] 6.2 实现动态提示更新


    - 添加工具列表缓存和刷新机制
    - 实现提示模板的配置化管理
    - 编写提示构建器的单元测试
    - _需求: 1.3, 10.3_

- [x] 7. 实现 MCP Client 服务核心组件




  - [x] 7.1 创建 MCP 服务器注册表


    - 实现 MCPServerRegistry 类管理服务器配置
    - 添加服务器注册、注销和查找方法
    - 实现配置持久化和自动加载逻辑
    - _需求: 1.1, 1.2, 10.1, 10.2_

  - [x] 7.2 实现 gRPC 服务端


    - 创建 MCPClientService 实现 gRPC 服务接口
    - 实现工具调用和工具列表获取方法
    - 添加错误处理和状态管理
    - _需求: 6.1, 6.2, 6.3_

- [x] 8. 实现 MCP 传输协议客户端




  - [x] 8.1 创建 MCPClient 接口和基础实现


    - 定义 MCPClient 接口统一不同传输协议
    - 实现基础的连接管理和生命周期控制
    - 添加工具调用和工具列表获取的抽象方法
    - _需求: 2.1, 2.2, 2.3_

  - [x] 8.2 实现 STDIO 传输协议客户端


    - 创建 MCPStdioClient 类
    - 实现进程启动、JSON-RPC 通信和进程管理
    - 添加握手协议和连接状态检查
    - _需求: 2.1, 9.1_

  - [x] 8.3 实现 SSE 传输协议客户端


    - 创建 MCPSseClient 类
    - 实现 HTTP 长轮询和事件流处理
    - 添加连接重试和错误恢复机制
    - _需求: 2.2, 9.1_

  - [x] 8.4 实现 Streamable HTTP 传输协议客户端


    - 创建 MCPStreamableHttpClient 类
    - 实现会话管理和双向通信
    - 添加断点续传和 Origin 验证
    - _需求: 2.3, 9.1_

- [x] 9. 实现 REST API 控制器




  - [x] 9.1 创建聊天 API 控制器


    - 实现 ChatController 处理前端聊天请求
    - 添加 POST /api/chat/message 端点
    - 实现 GET /api/chat/tools 和会话历史端点
    - _需求: 5.1, 5.2, 5.4_

  - [x] 9.2 创建 MCP 服务器管理 API


    - 实现 MCPServerController 管理服务器配置
    - 添加服务器增删改查的 REST 端点
    - 实现服务器健康检查和状态监控
    - _需求: 7.1, 7.2, 7.3, 9.3_

- [x] 10. 实现数据持久化层





  - [x] 10.1 创建数据库配置和实体


    - 配置 JPA 和数据库连接
    - 创建 McpServerSpec 实体和 Repository 接口
    - 实现数据库初始化脚本和迁移
    - _需求: 10.1, 10.2_

  - [x] 10.2 实现会话和配置存储


    - 创建会话管理和存储组件
    - 实现配置变更的同步更新机制
    - 编写数据访问层的单元测试
    - _需求: 5.2, 10.3, 10.4_

- [ ] 11. 实现错误处理和监控
  - [ ] 11.1 创建异常类层次结构
    - 定义 MCPException 基础异常类
    - 创建具体异常类：MCPConnectionException、ConversationException 等
    - 实现异常消息的国际化支持
    - _需求: 9.2, 6.4_

  - [ ] 11.2 实现全局异常处理和监控
    - 创建 GlobalExceptionHandler 处理所有异常
    - 实现标准化错误响应格式
    - 添加健康检查端点和监控指标
    - _需求: 9.2, 9.3, 9.4_

- [ ] 12. 实现安全性和权限控制
  - [ ] 12.1 添加基础安全配置
    - 配置 Spring Security 和 gRPC 安全
    - 实现 API 端点的权限控制
    - 添加 HTTPS 和 TLS 加密配置
    - _需求: 8.1, 8.2_

  - [ ] 12.2 实现操作审计和日志
    - 创建审计日志记录组件
    - 添加所有 MCP 操作的日志记录
    - 实现安全事件的监控和告警
    - _需求: 8.3, 8.4_

- [x] 13. 实现应用配置和启动逻辑




  - [x] 13.1 创建应用配置类


    - 实现 Spring Boot 配置类和 Bean 定义
    - 配置 gRPC 服务器和客户端
    - 添加线程池和异步处理配置
    - _需求: 10.2, 6.1_

  - [x] 13.2 实现启动时配置加载


    - 添加 ApplicationRunner 自动加载 MCP 服务器配置
    - 实现配置加载失败的降级处理
    - 添加服务启动健康检查逻辑
    - _需求: 10.2, 10.4, 9.3_

- [x] 14. 编写集成测试





  - [x] 14.1 创建端到端对话流程测试


    - 编写完整的对话处理流程集成测试
    - 测试 LLM 调用、指令解析和工具执行
    - 验证 gRPC 通信和错误处理
    - _需求: 5.1, 5.3, 6.2_

  - [x] 14.2 实现 MCP 传输协议集成测试


    - 编写各种传输协议的集成测试
    - 测试服务器配置管理和持久化
    - 验证安全性和权限控制功能
    - _需求: 2.1, 2.2, 2.3, 8.1_

- [-] 15. 创建前端 React 组件




  - [ ] 15.1 实现统一聊天界面




    - 创建聊天消息显示和输入组件
    - 实现消息发送和实时响应接收
    - 添加工具调用结果的可视化显示
    - _需求: 5.1, 5.2_

  - [ ] 15.2 实现 MCP 服务器管理界面
    - 创建服务器配置管理组件
    - 实现服务器添加、编辑和删除功能
    - 添加服务器状态监控和健康检查显示
    - _需求: 7.1, 7.2, 7.3_

- [ ] 16. 系统集成和部署配置
  - [ ] 16.1 创建 Docker 和容器化配置
    - 编写 MCP Host 和 Client 服务的 Dockerfile
    - 创建 docker-compose.yml 用于本地开发
    - 配置服务间网络和数据卷管理
    - _需求: 10.1_

  - [ ] 16.2 实现生产环境部署配置
    - 添加 Kubernetes 部署配置文件
    - 实现服务发现和负载均衡配置
    - 配置日志收集、监控和告警系统
    - _需求: 9.3, 9.4_