<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AIå›¾ç‰‡ç¼–è¾‘å™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        @media (max-width: 768px) {
            body {
                padding: 5px;
            }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        @media (max-width: 768px) {
            .container {
                border-radius: 10px;
                margin: 0 5px;
            }
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        @media (max-width: 768px) {
            .header {
                padding: 20px 15px;
            }
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            padding: 40px;
        }

        @media (max-width: 768px) {
            .main-content {
                padding: 15px;
            }
        }

        .upload-section {
            margin-bottom: 30px;
        }

        .upload-area {
            border: 3px dashed #ddd;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        @media (max-width: 768px) {
            .upload-area {
                padding: 20px;
                border-radius: 10px;
            }
        }

        .upload-area:hover {
            border-color: #4facfe;
            background-color: #f8f9ff;
        }

        .upload-area.dragover {
            border-color: #4facfe;
            background-color: #f0f8ff;
        }

        .upload-icon {
            font-size: 3em;
            color: #ddd;
            margin-bottom: 20px;
        }

        .upload-text {
            font-size: 1.2em;
            color: #666;
            margin-bottom: 15px;
        }

        .file-input {
            display: none;
        }

        .btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }

        @media (max-width: 768px) {
            .btn {
                padding: 15px 25px;
                font-size: 16px;
                width: 100%;
                margin-bottom: 10px;
                border-radius: 12px;
            }
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(79, 172, 254, 0.3);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-cancel {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
            display: none;
        }

        @media (max-width: 768px) {
            .btn-cancel {
                padding: 15px 25px;
                font-size: 16px;
                width: 100%;
                margin-bottom: 10px;
                border-radius: 12px;
            }
        }

        .btn-cancel:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(255, 107, 107, 0.3);
        }

        .input-section {
            margin-bottom: 30px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .input-group input, .input-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        @media (max-width: 768px) {
            .input-group input, .input-group textarea {
                padding: 12px;
                font-size: 16px;
                border-radius: 8px;
            }
        }

        .input-group input:focus, .input-group textarea:focus {
            outline: none;
            border-color: #4facfe;
        }

        .textarea {
            resize: vertical;
            min-height: 100px;
        }

        .preview-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 30px;
        }

        .image-preview {
            text-align: center;
        }

        .image-preview h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .image-container {
            border: 2px solid #e1e5e9;
            border-radius: 15px;
            padding: 20px;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f8f9fa;
        }

        .image-container img {
            max-width: 100%;
            max-height: 400px;
            border-radius: 10px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        .placeholder {
            color: #999;
            font-style: italic;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        @media (max-width: 768px) {
            .loading {
                padding: 15px;
                margin: 10px;
            }
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4facfe;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background-color: #fee;
            border: 1px solid #fcc;
            color: #c33;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            display: none;
        }

        .success {
            background-color: #efe;
            border: 1px solid #cfc;
            color: #3c3;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            display: none;
        }

        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            position: relative;
            margin: auto;
            padding: 20px;
            width: 90%;
            max-width: 1000px;
            height: 90%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @media (max-width: 768px) {
            .modal-content {
                width: 100%;
                height: 100%;
                padding: 20px;
                top: 0;
                transform: none;
                display: flex;
                flex-direction: column;
                justify-content: center;
            }
        }

        .modal-image {
            max-width: 100%;
            max-height: 100%;
            border-radius: 10px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
        }

        @media (max-width: 768px) {
            .modal-image {
                max-height: 70vh;
                border-radius: 5px;
            }
        }

        .close {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        @media (max-width: 768px) {
            .close {
                top: 10px;
                right: 15px;
                font-size: 30px;
            }
        }

        .close:hover {
            color: #4facfe;
        }

        .modal-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
        }

        @media (max-width: 768px) {
            .modal-controls {
                flex-direction: column;
                gap: 10px;
                bottom: 15px;
                width: 90%;
                left: 50%;
                transform: translateX(-50%);
            }
        }

        .modal-btn {
            background: rgba(79, 172, 254, 0.9);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        @media (max-width: 768px) {
            .modal-btn {
                padding: 15px 20px;
                font-size: 16px;
                width: 100%;
                margin: 0;
            }
        }

        .modal-btn:hover {
            background: rgba(79, 172, 254, 1);
            transform: translateY(-2px);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .image-container img {
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .image-container img:hover {
            transform: scale(1.02);
        }

        /* ä¸Šä¼ å›¾ç‰‡åˆ—è¡¨æ ·å¼ */
        .uploaded-image-item {
            position: relative;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            padding: 10px;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .uploaded-image-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        @media (max-width: 768px) {
            .uploaded-image-item {
                padding: 12px;
                margin-bottom: 12px;
                min-height: 140px;
                touch-action: manipulation;
            }
        }

        .uploaded-image-item img {
            width: 120px;
            height: 120px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
        }

        @media (max-width: 768px) {
            .uploaded-image-item img {
                width: 80px;
                height: 80px;
            }
        }

        .uploaded-image-item .image-info {
            margin-top: 8px;
            text-align: center;
            font-size: 0.8em;
            color: #666;
        }

        .uploaded-image-item .remove-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ff4757;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .uploaded-image-item .remove-btn:hover {
            background: #ff3742;
            transform: scale(1.1);
        }

        @media (max-width: 768px) {
            .uploaded-image-item .remove-btn {
                width: 35px;
                height: 35px;
                font-size: 20px;
                top: -8px;
                right: -8px;
                touch-action: manipulation;
            }
        }

        .image-order {
            position: absolute;
            top: 5px;
            left: 5px;
            background: rgba(79, 172, 254, 0.9);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .image-order {
                width: 30px;
                height: 30px;
                font-size: 14px;
                top: 5px;
                left: 5px;
            }
        }

        @media (max-width: 768px) {
            .preview-section {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .modal-content {
                width: 95%;
                height: 95%;
                padding: 10px;
            }
            
            .close {
                top: 10px;
                right: 20px;
                font-size: 30px;
            }
            
            .input-group input, .input-group textarea {
                font-size: 16px;
                -webkit-appearance: none;
                -webkit-border-radius: 8px;
            }
            
            .upload-text {
                font-size: 1em;
            }
            
            .upload-icon {
                font-size: 2em;
            }
            
            #imagesList {
                justify-content: center;
                gap: 10px;
            }
            
            .upload-area {
                touch-action: manipulation;
                -webkit-tap-highlight-color: transparent;
            }
            
            .btn {
                touch-action: manipulation;
                -webkit-tap-highlight-color: transparent;
            }
            
            .modal-btn {
                touch-action: manipulation;
                -webkit-tap-highlight-color: transparent;
            }
        }

        /* æç¤ºè¯ç¼“å­˜é¢æ¿æ ·å¼ */
        .prompt-cache-panel {
            background: #f8f9fa;
            border: 2px solid #e1e5e9;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .prompt-cache-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .prompt-cache-header h4 {
            color: #333;
            margin: 0;
        }

        .prompt-cache-toggle {
            background: #4facfe;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .prompt-cache-toggle:hover {
            background: #3d8bfe;
        }

        .prompt-cache-content {
            display: none;
        }

        .prompt-cache-content.show {
            display: block;
        }

        .prompt-item {
            background: white;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .prompt-item:hover {
            border-color: #4facfe;
            box-shadow: 0 2px 8px rgba(79, 172, 254, 0.2);
        }

        .prompt-item.active {
            border-color: #4facfe;
            background: #f0f8ff;
        }

        .prompt-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .prompt-content {
            color: #666;
            font-size: 0.9em;
            line-height: 1.4;
        }

        .prompt-delete {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ff4757;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 12px;
            display: none;
        }

        .prompt-item:hover .prompt-delete {
            display: block;
        }

        .add-prompt-form {
            background: white;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            display: none;
        }

        .add-prompt-form.show {
            display: block;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 0.9em;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-buttons {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 8px 15px;
            font-size: 0.9em;
            border-radius: 15px;
        }

        @media (max-width: 768px) {
            .prompt-cache-panel {
                padding: 15px;
                border-radius: 10px;
            }

            .prompt-cache-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .prompt-item {
                padding: 12px;
            }

            .form-buttons {
                flex-direction: column;
            }

            .btn-small {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¨ AIå›¾ç‰‡ç¼–è¾‘å™¨</h1>
            <p>ä½¿ç”¨AIæŠ€æœ¯ä¸ºæ‚¨çš„å›¾ç‰‡æ·»åŠ åˆ›æ„å…ƒç´ </p>
        </div>
        
        <div class="main-content">
            <div class="upload-section">
                <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                    <div class="upload-icon">ğŸ“·</div>
                    <div class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å›¾ç‰‡</div>
                    <div style="color: #999; font-size: 0.9em;">æ”¯æŒ JPG, PNG, GIF æ ¼å¼ï¼Œå¯åŒæ—¶é€‰æ‹©å¤šå¼ å›¾ç‰‡</div>
                    <input type="file" id="fileInput" class="file-input" accept="image/*" multiple>
                </div>
                
                <!-- å·²ä¸Šä¼ å›¾ç‰‡é¢„è§ˆåŒºåŸŸ -->
                <div id="uploadedImages" style="margin-top: 20px; display: none;">
                    <h4 style="margin-bottom: 15px; color: #333;">å·²ä¸Šä¼ çš„å›¾ç‰‡ (æŒ‰é¡ºåºæ’åˆ—):</h4>
                    <div id="imagesList" style="display: flex; flex-wrap: wrap; gap: 15px;"></div>
                    <button class="btn" onclick="clearAllImages()" style="margin-top: 15px; background: #ff6b6b;">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰å›¾ç‰‡</button>
                </div>
            </div>
            
            <div class="input-section">
                <div class="input-group">
                    <label for="apiKey">APIå¯†é’¥:</label>
                    <input type="password" id="apiKey" placeholder="è¯·è¾“å…¥æ‚¨çš„APIå¯†é’¥">
                </div>

                <!-- æç¤ºè¯ç¼“å­˜é¢æ¿ -->
                <div class="prompt-cache-panel">
                    <div class="prompt-cache-header">
                        <h4>ğŸ“ æç¤ºè¯ç¼“å­˜</h4>
                        <button class="prompt-cache-toggle" onclick="togglePromptCache()">å±•å¼€/æ”¶èµ·</button>
                    </div>
                    <div class="prompt-cache-content" id="promptCacheContent">
                        <div id="promptList"></div>
                        <button class="btn btn-small" onclick="showAddPromptForm()">â• æ·»åŠ æ–°æç¤ºè¯</button>

                        <div class="add-prompt-form" id="addPromptForm">
                            <div class="form-group">
                                <label for="promptTitle">æ ‡é¢˜:</label>
                                <input type="text" id="promptTitle" placeholder="ç»™è¿™ä¸ªæç¤ºè¯èµ·ä¸ªåå­—">
                            </div>
                            <div class="form-group">
                                <label for="promptContent">æç¤ºè¯å†…å®¹:</label>
                                <textarea id="promptContent" placeholder="è¾“å…¥æç¤ºè¯å†…å®¹..."></textarea>
                            </div>
                            <div class="form-buttons">
                                <button class="btn btn-small" onclick="savePrompt()">ğŸ’¾ ä¿å­˜</button>
                                <button class="btn btn-small" onclick="cancelAddPrompt()" style="background: #6c757d;">âŒ å–æ¶ˆ</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="input-group">
                    <label for="editPrompt">ç¼–è¾‘æŒ‡ä»¤:</label>
                    <textarea id="editPrompt" class="textarea" placeholder="ä¾‹å¦‚: å°†è¿™äº›å›¾ç‰‡åˆæˆä¸€å¼ ï¼Œåœ¨æˆ‘æ—è¾¹æ·»åŠ ä¸€åªå¯çˆ±çš„ç¾Šé©¼">è¯·æ ¹æ®æˆ‘ä¸Šä¼ çš„å›¾ç‰‡è¿›è¡Œåˆ›æ„ç¼–è¾‘ï¼Œå¯ä»¥åˆæˆã€ä¿®æ”¹æˆ–æ·»åŠ æ–°å…ƒç´ </textarea>
                </div>

                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn" onclick="processImage()" id="processBtn">ğŸš€ å¼€å§‹ç¼–è¾‘</button>
                    <button class="btn-cancel" onclick="cancelRequest()" id="cancelBtn">â¹ï¸ ä¸­æ–­è¯·æ±‚</button>
                </div>
            </div>
            
            <div class="error" id="errorMsg"></div>
            <div class="success" id="successMsg"></div>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <div>AIæ­£åœ¨å¤„ç†æ‚¨çš„å›¾ç‰‡ï¼Œè¯·ç¨å€™...</div>
            </div>
            
            <div class="preview-section">
                <div class="image-preview">
                    <h3>åŸå§‹å›¾ç‰‡</h3>
                    <div class="image-container" id="originalImage">
                        <div class="placeholder">è¯·å…ˆä¸Šä¼ å›¾ç‰‡</div>
                    </div>
                </div>
                
                <div class="image-preview">
                    <h3>ç¼–è¾‘ç»“æœ</h3>
                    <div class="image-container" id="editedImage">
                        <div class="placeholder">ç¼–è¾‘åçš„å›¾ç‰‡å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å›¾ç‰‡æ”¾å¤§æŸ¥çœ‹æ¨¡æ€æ¡† -->
    <div id="imageModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <img id="modalImage" class="modal-image" src="" alt="æ”¾å¤§æŸ¥çœ‹">
            <div class="modal-controls">
                <button class="modal-btn" onclick="downloadModalImage()">ğŸ’¾ ä¸‹è½½å›¾ç‰‡</button>
                <button class="modal-btn" onclick="closeModal()">âŒ å…³é—­</button>
            </div>
        </div>
    </div>

    <script>
        let selectedFiles = [];
        let originalImageData = null;
        let currentRequest = null; // ç”¨äºå­˜å‚¨å½“å‰çš„è¯·æ±‚ï¼Œä»¥ä¾¿ä¸­æ–­
        let currentResponseId = null; // ç”¨äºå­˜å‚¨å½“å‰å“åº”çš„ID
        let promptCache = []; // æç¤ºè¯ç¼“å­˜æ•°ç»„

        // æ–‡ä»¶ä¸Šä¼ å¤„ç†
        document.getElementById('fileInput').addEventListener('change', handleFileSelect);
        
        // æ‹–æ‹½ä¸Šä¼ 
        const uploadArea = document.querySelector('.upload-area');
        uploadArea.addEventListener('dragover', handleDragOver);
        uploadArea.addEventListener('dragleave', handleDragLeave);
        uploadArea.addEventListener('drop', handleDrop);

        function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            if (files.length > 0) {
                processFiles(files);
            }
            // æ¸…ç©ºæ–‡ä»¶è¾“å…¥æ¡†çš„å€¼ï¼Œå…è®¸é‡å¤é€‰æ‹©ç›¸åŒæ–‡ä»¶
            event.target.value = '';
        }

        function handleDragOver(event) {
            event.preventDefault();
            uploadArea.classList.add('dragover');
        }

        function handleDragLeave(event) {
            event.preventDefault();
            uploadArea.classList.remove('dragover');
        }

        function handleDrop(event) {
            event.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const files = Array.from(event.dataTransfer.files);
            if (files.length > 0) {
                processFiles(files);
            }
        }

        function processFiles(files) {
            const validFiles = files.filter(file => file.type.startsWith('image/'));
            
            if (validFiles.length === 0) {
                showError('è¯·é€‰æ‹©æœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶');
                return;
            }
            
            if (validFiles.length !== files.length) {
                showError(`å·²è¿‡æ»¤æ‰ ${files.length - validFiles.length} ä¸ªéå›¾ç‰‡æ–‡ä»¶`);
            }
            
            // æ·»åŠ åˆ°å·²é€‰æ‹©çš„æ–‡ä»¶åˆ—è¡¨
            validFiles.forEach(file => {
                if (!selectedFiles.some(f => f.name === file.name && f.size === file.size)) {
                    selectedFiles.push(file);
                }
            });
            
            updateImagesList();
            showSuccess(`æˆåŠŸæ·»åŠ  ${validFiles.length} å¼ å›¾ç‰‡ï¼`);
        }

        function updateImagesList() {
            const uploadedImagesDiv = document.getElementById('uploadedImages');
            const imagesListDiv = document.getElementById('imagesList');
            
            if (selectedFiles.length === 0) {
                uploadedImagesDiv.style.display = 'none';
                return;
            }
            
            uploadedImagesDiv.style.display = 'block';
            imagesListDiv.innerHTML = '';
            
            selectedFiles.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageItem = document.createElement('div');
                    imageItem.className = 'uploaded-image-item';
                    imageItem.innerHTML = `
                        <div class="image-order">${index + 1}</div>
                        <img src="${e.target.result}" alt="${file.name}" onclick="openModal('${e.target.result}', '${file.name}')">
                        <div class="image-info">${file.name}</div>
                        <button class="remove-btn" onclick="removeImage(${index})" title="åˆ é™¤å›¾ç‰‡">Ã—</button>
                    `;
                    imagesListDiv.appendChild(imageItem);
                };
                reader.readAsDataURL(file);
            });
            
            // æ›´æ–°åŸå›¾æ˜¾ç¤ºï¼ˆæ˜¾ç¤ºç¬¬ä¸€å¼ å›¾ç‰‡ï¼‰
            if (selectedFiles.length > 0) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    originalImageData = e.target.result;
                    displayOriginalImage(originalImageData);
                };
                reader.readAsDataURL(selectedFiles[0]);
            }
        }

        function removeImage(index) {
            selectedFiles.splice(index, 1);
            updateImagesList();
            showSuccess('å›¾ç‰‡å·²åˆ é™¤');
        }

        function clearAllImages() {
            selectedFiles = [];
            updateImagesList();
            document.getElementById('originalImage').innerHTML = '<div class="placeholder">è¯·å…ˆä¸Šä¼ å›¾ç‰‡</div>';
            showSuccess('å·²æ¸…ç©ºæ‰€æœ‰å›¾ç‰‡');
        }

        function displayOriginalImage(imageSrc) {
            const container = document.getElementById('originalImage');
            container.innerHTML = `<img src="${imageSrc}" alt="åŸå§‹å›¾ç‰‡" onclick="openModal('${imageSrc}', 'åŸå§‹å›¾ç‰‡')">`;
        }

        function showError(message, persistent = false) {
            const errorDiv = document.getElementById('errorMsg');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';

            // å¦‚æœä¸æ˜¯å¸¸é©»é”™è¯¯ï¼Œ5ç§’åè‡ªåŠ¨éšè—
            if (!persistent) {
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                }, 5000);
            }
        }

        function hideError() {
            const errorDiv = document.getElementById('errorMsg');
            errorDiv.style.display = 'none';
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('successMsg');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 3000);
        }

        function showLoading(show) {
            const loading = document.getElementById('loading');
            const processBtn = document.getElementById('processBtn');
            const cancelBtn = document.getElementById('cancelBtn');

            if (show) {
                loading.style.display = 'block';
                processBtn.disabled = true;
                cancelBtn.style.display = 'inline-block';
            } else {
                loading.style.display = 'none';
                processBtn.disabled = false;
                cancelBtn.style.display = 'none';
            }
        }

        async function processImage() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const editPrompt = document.getElementById('editPrompt').value.trim();

            // éšè—ä¹‹å‰çš„é”™è¯¯æç¤º
            hideError();

            // éªŒè¯è¾“å…¥
            if (!apiKey) {
                showError('è¯·è¾“å…¥APIå¯†é’¥');
                return;
            }

            if (!editPrompt) {
                showError('è¯·è¾“å…¥ç¼–è¾‘æŒ‡ä»¤');
                return;
            }

            if (selectedFiles.length === 0) {
                showError('è¯·å…ˆä¸Šä¼ å›¾ç‰‡');
                return;
            }

            showLoading(true);
            
            try {
                // æ„å»ºpartsæ•°ç»„ï¼Œå…ˆæ·»åŠ æ–‡æœ¬æç¤º
                const parts = [{
                    text: editPrompt
                }];
                
                // æŒ‰ä¸Šä¼ é¡ºåºæ·»åŠ æ‰€æœ‰å›¾ç‰‡
                for (const file of selectedFiles) {
                    const base64Data = await fileToBase64(file);
                    parts.push({
                        inlineData: {
                            mimeType: file.type,
                            data: base64Data
                        }
                    });
                }
                
                // æ„å»ºè¯·æ±‚ä½“
                const requestBody = {
                    contents: [
                        {
                            role: "user",
                            parts: parts
                        }
                    ],
                    generationConfig: {
                        responseModalities: [
                            "TEXT",
                            "IMAGE"
                        ]
                    }
                };

                // åˆ›å»ºAbortControllerç”¨äºä¸­æ–­è¯·æ±‚
                const controller = new AbortController();
                currentRequest = controller;

                // å‘é€è¯·æ±‚
                const response = await fetch('https://yunwu.ai/v1beta/models/gemini-2.5-flash-image-preview:generateContent', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify(requestBody),
                    signal: controller.signal
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || `HTTPé”™è¯¯: ${response.status}`);
                }

                const result = await response.json();

                // æå–responseId
                currentResponseId = result.responseId || null;

                // å¤„ç†å“åº”
                if (result.candidates && result.candidates.length > 0) {
                    const candidate = result.candidates[0];

                    // æŸ¥æ‰¾å›¾ç‰‡æ•°æ®
                    let imageData = null;
                    let mimeType = null;
                    for (const part of candidate.content.parts) {
                        if (part.inlineData && part.inlineData.mimeType.startsWith('image/')) {
                            imageData = part.inlineData.data;
                            mimeType = part.inlineData.mimeType;
                            break;
                        }
                    }

                    if (imageData && mimeType) {
                        displayEditedImage(imageData, mimeType);
                        showSuccess('å›¾ç‰‡ç¼–è¾‘å®Œæˆï¼');
                    } else {
                        showError('APIè¿”å›çš„æ•°æ®ä¸­æœªæ‰¾åˆ°ç¼–è¾‘åçš„å›¾ç‰‡', true); // å¸¸é©»é”™è¯¯æç¤º
                    }
                } else {
                    showError('APIè¿”å›äº†æ— æ•ˆçš„å“åº”æ ¼å¼', true); // å¸¸é©»é”™è¯¯æç¤º
                }
                
            } catch (error) {
                console.error('å¤„ç†å›¾ç‰‡æ—¶å‡ºé”™:', error);
                if (error.name === 'AbortError') {
                    showError('è¯·æ±‚å·²è¢«ä¸­æ–­');
                } else {
                    showError(`å¤„ç†å¤±è´¥: ${error.message}`);
                }
            } finally {
                showLoading(false);
                currentRequest = null;
            }
        }

        // ä¸­æ–­è¯·æ±‚å‡½æ•°
        function cancelRequest() {
            if (currentRequest) {
                currentRequest.abort();
                currentRequest = null;
                showLoading(false);
                showError('è¯·æ±‚å·²ä¸­æ–­');
            }
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    // ç§»é™¤data:image/jpeg;base64,å‰ç¼€
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function displayEditedImage(base64Data, mimeType) {
            const container = document.getElementById('editedImage');
            const imageSrc = `data:${mimeType};base64,${base64Data}`;
            const fileExtension = mimeType.split('/')[1] || 'jpg';

            // ç”Ÿæˆæ–‡ä»¶åï¼šnano-bananaæ‹¼æ¥responseId
            let fileName = 'nano-banana';
            if (currentResponseId) {
                fileName += `-${currentResponseId}`;
            } else {
                // å¦‚æœæ²¡æœ‰responseIdï¼Œä½¿ç”¨æ—¶é—´æˆ³ä½œä¸ºåå¤‡
                fileName += `-${Date.now()}`;
            }
            fileName += `.${fileExtension}`;

            container.innerHTML = `
                <img src="${imageSrc}" alt="ç¼–è¾‘åçš„å›¾ç‰‡" onclick="openModal('${imageSrc}', 'ç¼–è¾‘åçš„å›¾ç‰‡')">
                <div style="margin-top: 15px;">
                    <button class="btn" onclick="downloadImage('${imageSrc}', '${fileName}')">ğŸ’¾ ä¸‹è½½å›¾ç‰‡</button>
                    <button class="btn" onclick="openModal('${imageSrc}', 'ç¼–è¾‘åçš„å›¾ç‰‡')">ğŸ” æ”¾å¤§æŸ¥çœ‹</button>
                </div>
            `;
        }

        function downloadImage(imageSrc, filename) {
            const link = document.createElement('a');
            link.href = imageSrc;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // æ¨¡æ€æ¡†ç›¸å…³å‡½æ•°
        function openModal(imageSrc, altText) {
            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            
            modalImage.src = imageSrc;
            modalImage.alt = altText;
            modal.style.display = 'block';
            
            // å­˜å‚¨å½“å‰å›¾ç‰‡ä¿¡æ¯ç”¨äºä¸‹è½½
            modal.dataset.currentImageSrc = imageSrc;
            modal.dataset.currentImageAlt = altText;
        }

        function closeModal() {
            const modal = document.getElementById('imageModal');
            modal.style.display = 'none';
        }

        function downloadModalImage() {
            const modal = document.getElementById('imageModal');
            const imageSrc = modal.dataset.currentImageSrc;
            const altText = modal.dataset.currentImageAlt;

            if (imageSrc) {
                let fileName;
                if (altText === 'åŸå§‹å›¾ç‰‡') {
                    fileName = 'original-image.jpg';
                } else {
                    // å¯¹äºç¼–è¾‘åçš„å›¾ç‰‡ï¼Œä½¿ç”¨nano-bananaå‘½å
                    fileName = 'nano-banana';
                    if (currentResponseId) {
                        fileName += `-${currentResponseId}`;
                    } else {
                        fileName += `-${Date.now()}`;
                    }
                    fileName += '.png';
                }
                downloadImage(imageSrc, fileName);
            }
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
        document.getElementById('imageModal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeModal();
            }
        });

        // ESCé”®å…³é—­æ¨¡æ€æ¡†
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeModal();
            }
        });

        // ä¿å­˜æ•°æ®åˆ°localStorage
        function saveToLocalStorage() {
            const apiKey = document.getElementById('apiKey').value;
            const editPrompt = document.getElementById('editPrompt').value;

            localStorage.setItem('ai-image-editor-apikey', apiKey);
            localStorage.setItem('ai-image-editor-prompt', editPrompt);
            localStorage.setItem('ai-image-editor-prompt-cache', JSON.stringify(promptCache));
        }

        // ä»localStorageæ¢å¤æ•°æ®
        function loadFromLocalStorage() {
            const savedApiKey = localStorage.getItem('ai-image-editor-apikey');
            const savedPrompt = localStorage.getItem('ai-image-editor-prompt');
            const savedPromptCache = localStorage.getItem('ai-image-editor-prompt-cache');

            if (savedApiKey) {
                document.getElementById('apiKey').value = savedApiKey;
            }

            if (savedPrompt) {
                document.getElementById('editPrompt').value = savedPrompt;
            }

            if (savedPromptCache) {
                try {
                    promptCache = JSON.parse(savedPromptCache);
                    renderPromptList();
                } catch (e) {
                    console.error('åŠ è½½æç¤ºè¯ç¼“å­˜å¤±è´¥:', e);
                    promptCache = [];
                }
            }
        }

        // æç¤ºè¯ç¼“å­˜ç›¸å…³å‡½æ•°
        function togglePromptCache() {
            const content = document.getElementById('promptCacheContent');
            content.classList.toggle('show');
        }

        function showAddPromptForm() {
            const form = document.getElementById('addPromptForm');
            form.classList.add('show');
            document.getElementById('promptTitle').focus();
        }

        function cancelAddPrompt() {
            const form = document.getElementById('addPromptForm');
            form.classList.remove('show');
            document.getElementById('promptTitle').value = '';
            document.getElementById('promptContent').value = '';
        }

        function savePrompt() {
            const title = document.getElementById('promptTitle').value.trim();
            const content = document.getElementById('promptContent').value.trim();

            if (!title) {
                alert('è¯·è¾“å…¥æ ‡é¢˜');
                return;
            }

            if (!content) {
                alert('è¯·è¾“å…¥æç¤ºè¯å†…å®¹');
                return;
            }

            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒæ ‡é¢˜
            if (promptCache.some(p => p.title === title)) {
                if (!confirm('å·²å­˜åœ¨ç›¸åŒæ ‡é¢˜çš„æç¤ºè¯ï¼Œæ˜¯å¦è¦†ç›–ï¼Ÿ')) {
                    return;
                }
                // åˆ é™¤æ—§çš„
                promptCache = promptCache.filter(p => p.title !== title);
            }

            // æ·»åŠ æ–°æç¤ºè¯
            promptCache.unshift({
                id: Date.now(),
                title: title,
                content: content,
                createdAt: new Date().toLocaleString()
            });

            // ä¿å­˜åˆ°localStorage
            saveToLocalStorage();

            // é‡æ–°æ¸²æŸ“åˆ—è¡¨
            renderPromptList();

            // éšè—è¡¨å•
            cancelAddPrompt();

            showSuccess(`æç¤ºè¯ "${title}" å·²ä¿å­˜`);
        }

        function renderPromptList() {
            const listContainer = document.getElementById('promptList');

            if (promptCache.length === 0) {
                listContainer.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">æš‚æ— ä¿å­˜çš„æç¤ºè¯</div>';
                return;
            }

            listContainer.innerHTML = promptCache.map(prompt => `
                <div class="prompt-item" onclick="applyPrompt('${prompt.id}')">
                    <div class="prompt-title">${escapeHtml(prompt.title)}</div>
                    <div class="prompt-content">${escapeHtml(prompt.content.substring(0, 100))}${prompt.content.length > 100 ? '...' : ''}</div>
                    <button class="prompt-delete" onclick="event.stopPropagation(); deletePrompt('${prompt.id}')" title="åˆ é™¤">Ã—</button>
                </div>
            `).join('');
        }

        function applyPrompt(promptId) {
            const prompt = promptCache.find(p => p.id == promptId);
            if (prompt) {
                document.getElementById('editPrompt').value = prompt.content;
                saveToLocalStorage(); // ä¿å­˜åº”ç”¨çš„æç¤ºè¯
                showSuccess(`å·²åº”ç”¨æç¤ºè¯: ${prompt.title}`);

                // é«˜äº®é€‰ä¸­çš„æç¤ºè¯
                document.querySelectorAll('.prompt-item').forEach(item => {
                    item.classList.remove('active');
                });
                event.target.closest('.prompt-item').classList.add('active');
            }
        }

        function deletePrompt(promptId) {
            const prompt = promptCache.find(p => p.id == promptId);
            if (prompt && confirm(`ç¡®å®šè¦åˆ é™¤æç¤ºè¯ "${prompt.title}" å—ï¼Ÿ`)) {
                promptCache = promptCache.filter(p => p.id != promptId);
                saveToLocalStorage();
                renderPromptList();
                showSuccess('æç¤ºè¯å·²åˆ é™¤');
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // åˆå§‹åŒ–é»˜è®¤æç¤ºè¯
        function initDefaultPrompts() {
            if (promptCache.length === 0) {
                promptCache = [
                    {
                        id: 1,
                        title: "ğŸ¨ åˆ›æ„åˆæˆ",
                        content: "è¯·å°†è¿™äº›å›¾ç‰‡åˆ›æ„åˆæˆä¸ºä¸€å¼ å›¾ç‰‡ï¼Œä¿æŒè‡ªç„¶å’Œè°çš„æ•ˆæœ",
                        createdAt: new Date().toLocaleString()
                    },
                    {
                        id: 2,
                        title: "ğŸŒŸ æ·»åŠ ç‰¹æ•ˆ",
                        content: "ä¸ºå›¾ç‰‡æ·»åŠ æ¢¦å¹»çš„å…‰æ•ˆå’Œç²’å­ç‰¹æ•ˆï¼Œè¥é€ é­”æ³•èˆ¬çš„æ°›å›´",
                        createdAt: new Date().toLocaleString()
                    },
                    {
                        id: 3,
                        title: "ğŸ­ é£æ ¼è½¬æ¢",
                        content: "å°†å›¾ç‰‡è½¬æ¢ä¸ºæ²¹ç”»é£æ ¼ï¼Œè‰²å½©ä¸°å¯Œï¼Œç¬”è§¦æ˜æ˜¾",
                        createdAt: new Date().toLocaleString()
                    },
                    {
                        id: 4,
                        title: "ğŸŒˆ è‰²å½©å¢å¼º",
                        content: "å¢å¼ºå›¾ç‰‡çš„è‰²å½©é¥±å’Œåº¦å’Œå¯¹æ¯”åº¦ï¼Œè®©ç”»é¢æ›´åŠ ç”ŸåŠ¨é²œè‰³",
                        createdAt: new Date().toLocaleString()
                    },
                    {
                        id: 5,
                        title: "ğŸï¸ èƒŒæ™¯æ›¿æ¢",
                        content: "ä¿æŒä¸»ä½“ä¸å˜ï¼Œå°†èƒŒæ™¯æ›¿æ¢ä¸ºç¾ä¸½çš„è‡ªç„¶é£æ™¯",
                        createdAt: new Date().toLocaleString()
                    }
                ];
                saveToLocalStorage();
                renderPromptList();
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('AIå›¾ç‰‡ç¼–è¾‘å™¨å·²åŠ è½½å®Œæˆ');

            // æ¢å¤ä¿å­˜çš„æ•°æ®
            loadFromLocalStorage();

            // åˆå§‹åŒ–é»˜è®¤æç¤ºè¯
            initDefaultPrompts();

            // ç›‘å¬è¾“å…¥å˜åŒ–ï¼Œè‡ªåŠ¨ä¿å­˜
            document.getElementById('apiKey').addEventListener('input', saveToLocalStorage);
            document.getElementById('editPrompt').addEventListener('input', saveToLocalStorage);
        });
    </script>
</body>
</html>